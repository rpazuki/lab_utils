# Preprocessing Pipeline Configuration for fitting the OD data
pipelines:
    - pipeline_NAME:
        Inputs:
            #####################################
            # Measurment csv
            - raw_data:
                - src: EMPTY
                - package:  labUtils.media_bot
                - method: parse_raw_CLARIOstar_export
                - value_column_name: od600
            # Protocol metadata csv
            - meta_data:
                - src: EMPTY
                - package:  labUtils.media_bot
                - method: parse_protocol_metadata
        Processes:
            #####################################
            # Parse raw data and metadata into
            # a tidy dataframe
            - df_parsed: # output dataframe name
                package: labUtils.media_bot
                method: parse
                parameters:
                    raw_data: raw_data # The 'raw_data' input defined above
                    meta_data: meta_data # The 'meta_data' input defined above
                    value_column_name: od600 # The column name for OD values in output dataframe
            #####################################
            # Generate a report summarizing the raw data
            - df_report:  # output dataframe name
                package: labUtils.media_bot
                method: report
                parameters:
                    raw_data: raw_data # The 'raw_data' input defined above
                    meta_data: meta_data # The 'meta_data' input defined above
                    value_column_name: od600 # The column name for OD values in output dataframe
            #####################################
            # Calculate replicates statistics
            - df_replicate_stats:  # output dataframe name
                package: labUtils.media_bot
                method: calculate_replicate_statistics_by_well
                parameters:
                    df_parsed: df_parsed # The 'df_parsed' that was created above
                    direction: alphabetical # along A, B, C, ...
                    sample_size: 3 # e.g A1, A2, A3 - B1, B2, B3
                    ddof: 0 # Biased std
                    value_column_name: od600 # The column name for OD values in df_parsed dataframe
            #####################################
            # Transform OD to log(OD/OD_0)
            - df_transformed:  # output dataframe name
                package: labUtils.growth_rates
                method: transform_to_log_n_n0
                parameters:
                    df: df_replicate_stats # The 'df_replicate_stats' that was created above
                    value_col: od600_mean # The column name for OD values in df_replicate_stats dataframe
                    transformed_col: log_od_od0 # The column name for transformed log(OD/OD_0) values in output dataframe
                    OD_0_averaging_window: 4 # The OD_0 is defined based on the first 4 time points
                    group_cols: # columns defining each growth series
                        - group_id
            #####################################
            # Fit modified Gompertz model to each growth series
            - df_fit_modified_gompertz:  # output dataframe name
                package: labUtils.growth_rates
                method: fit_modified_gompertz_per_series
                parameters:
                    df: df_transformed # The 'df_transformed' that was created above
                    time_col: time_h # The column name for time values in df_transformed dataframe
                    value_col: log_od_od0 # The column name for transformed log(OD/OD_0) values in df_transformed dataframe
                    standard_deviation_column: od600_std # The column name for standard deviation of OD values in df_replicate_stats dataframe
                    clip_exp: 50.0 # numerical safety against overflow in exp(exp(.))
                    min_points: 5 # require at least this many points to fit
                    group_cols: # columns defining each growth series
                        - group_id
                    save_plot_data: true # whether to save plot of the data and fit
                    fixed_params:
                        y0: 0.0 # Fix y0 to 0.0


        Outputs:
            #####################################
            # List of output dataframes to save
            # to csv files
            - df_parsed: parsed_data.csv
            - df_report: report.csv
            - df_fit_modified_gompertz: [growth_rates.csv, predictions.csv]
